# 02. Invalidating Load Functions

Invalidation is how you tell SvelteKit to re-run load functions and refresh data. This document covers invalidation methods and patterns for keeping your application data fresh.

---

## üéØ What Is Invalidation?

**Invalidation** marks data as stale and triggers load functions to re-run. It's the primary mechanism for refreshing data without a full page reload.

### When Load Functions Re-run

| Trigger | Description | Example |
| :--- | :--- | :--- |
| **Navigation** | User navigates to a different route | Click a link |
| **URL Change** | Route params or search params change | `/posts/1` ‚Üí `/posts/2` |
| **Manual Invalidation** | You call `invalidate()` or `invalidateAll()` | Refresh button |
| **Form Submission** | After a form action completes | Submit a form |
| **Parent Re-run** | Parent layout load re-runs | User logs in |

---

## üîÑ Invalidation Methods

### 1. `invalidate(resource)` - Targeted Invalidation

Re-runs load functions that depend on a specific resource.

> [!IMPORTANT]
> `invalidate()` and `invalidateAll()` run on the **client-side only** (imported from `$app/navigation`). You cannot use them inside server-side load functions (`+page.server.js`).


```javascript
import { invalidate } from '$app/navigation';

// Invalidate by URL
await invalidate('/api/posts');

// Invalidate by custom dependency
await invalidate('app:user');

// Invalidate by function (predicate)
await invalidate(url => url.pathname.startsWith('/api/'));
```

#### Example: Refresh Button

```svelte
<!-- src/routes/posts/+page.svelte -->
<script>
    import { invalidate } from '$app/navigation';
    
    export let data;
    
    async function refresh() {
        await invalidate('/api/posts');
    }
</script>

<button onclick={refresh}>Refresh Posts</button>

{#each data.posts as post}
    <article>
        <h2>{post.title}</h2>
        <p>{post.excerpt}</p>
    </article>
{/each}
```

```javascript
// src/routes/posts/+page.js
export async function load({ fetch }) {
    const posts = await fetch('/api/posts').then(r => r.json());
    return { posts };
}
```

### 2. `invalidateAll()` - Global Invalidation

Re-runs **all** active load functions.

```javascript
import { invalidateAll } from '$app/navigation';

// Invalidate everything
await invalidateAll();
```

#### When to Use `invalidateAll()`

```javascript
// ‚úÖ GOOD: After login/logout (affects many loads)
async function logout() {
    await fetch('/api/logout', { method: 'POST' });
    await invalidateAll();
    goto('/');
}

// ‚ùå BAD: After updating a single item
async function updatePost(id, data) {
    await fetch(`/api/posts/${id}`, { method: 'PUT', body: JSON.stringify(data) });
    await invalidateAll(); // Overkill! Use invalidate('/api/posts') instead
}
```

### 3. Predicate-Based Invalidation

Use a function to selectively invalidate resources.

```javascript
import { invalidate } from '$app/navigation';

// Invalidate all API endpoints
await invalidate(url => url.pathname.startsWith('/api/'));

// Invalidate specific resource types
await invalidate(url => url.pathname.includes('/posts'));
```

---

## üéØ Custom Dependencies with `depends()`

Declare custom dependency keys for fine-grained invalidation control.

```javascript
// src/routes/dashboard/+page.js
export async function load({ fetch, depends }) {
    depends('app:dashboard');
    
    const stats = await fetch('/api/stats').then(r => r.json());
    return { stats };
}
```

```svelte
<!-- Anywhere in your app -->
<script>
    import { invalidate } from '$app/navigation';
    
    async function refreshDashboard() {
        await invalidate('app:dashboard');
    }
</script>

<button onclick={refreshDashboard}>Refresh</button>
```

---

## üîÅ Automatic Invalidation After Form Actions

SvelteKit automatically invalidates loads after form actions complete.

```javascript
// src/routes/posts/+page.server.js
export const actions = {
    create: async ({ request }) => {
        const data = await request.formData();
        await createPost(data);
        
        // Load function automatically re-runs after this!
        return { success: true };
    }
};

export async function load({ fetch }) {
    const posts = await fetch('/api/posts').then(r => r.json());
    return { posts };
}
```

---

## ‚è±Ô∏è Polling and Auto-Refresh

### Interval-Based Polling

```svelte
<!-- src/routes/dashboard/+page.svelte -->
<script>
    import { invalidate } from '$app/navigation';
    import { onMount, onDestroy } from 'svelte';
    
    export let data;
    
    let interval;
    
    onMount(() => {
        // Poll every 30 seconds
        interval = setInterval(() => {
            invalidate('app:dashboard');
        }, 30000);
    });
    
    onDestroy(() => {
        clearInterval(interval);
    });
</script>

<h1>Dashboard</h1>
<p>Last updated: {new Date().toLocaleTimeString()}</p>
<div>{data.stats.activeUsers} active users</div>
```


---

## üÜö `invalidate()` vs `invalidateAll()`

| Feature | `invalidate(resource)` | `invalidateAll()` |
| :--- | :--- | :--- |
| **Scope** | Targeted (specific URLs or keys) | Global (everything) |
| **Performance** | High (only refreshes what's needed) | Low (refreshes everything) |
| **Use Case** | Updating specific data (e.g., liked a post) | Major state changes (e.g., login/logout, language change) |
| **Impact** | Minimal network requests | Maximum network requests |

> [!TIP]
> Always prefer `invalidate()` for specific actions. Reserve `invalidateAll()` for app-wide state changes where almost every piece of data on the page could be stale.

---



---

## üìä Invalidation Decision Tree

```
Need to refresh data?
‚îÇ
‚îú‚îÄ After form submission?
‚îÇ  ‚îî‚îÄ Automatic (or use invalidate() for specific resources)
‚îÇ
‚îú‚îÄ After user action (button click)?
‚îÇ  ‚îú‚îÄ Single resource ‚Üí invalidate('/api/resource')
‚îÇ  ‚îú‚îÄ Custom dependency ‚Üí invalidate('app:key')
‚îÇ  ‚îî‚îÄ Everything ‚Üí invalidateAll()
‚îÇ
‚îú‚îÄ Periodic refresh?
‚îÇ  ‚îî‚îÄ setInterval + invalidate()
‚îÇ
‚îî‚îÄ After navigation?
   ‚îî‚îÄ Automatic (URL/param dependencies)
```

---

## üìã Summary

| Method | Use Case | Example |
| :--- | :--- | :--- |
| `invalidate(url)` | Refresh specific fetch URL | `invalidate('/api/posts')` |
| `invalidate(key)` | Refresh custom dependency | `invalidate('app:user')` |
| `invalidate(fn)` | Refresh by predicate | `invalidate(url => url.pathname.startsWith('/api/'))` |
| `invalidateAll()` | Refresh everything | After login/logout |
| Automatic | After form actions | Built-in behavior |

---

**Next Up**: [Re-running Load Functions on Error](./03.%20Re-running%20Load%20Functions%20on%20Error.md) ‚Üí
