# 01. Load Functions Dependencies

Understanding how load functions track and manage dependencies is crucial for building efficient SvelteKit applications. This document covers dependency tracking and the `depends()` function.

---

## ðŸŽ¯ What Are Load Dependencies?

Load dependencies determine **when a load function should re-run**. SvelteKit automatically tracks dependencies based on what your load function uses, but you can also declare custom dependencies.

### Automatic Dependencies

SvelteKit automatically tracks these as dependencies:

| Dependency Type | Example | When It Re-runs |
| :--- | :--- | :--- |
| **URL Parameters** | `params.id` | When the parameter changes |
| **Search Parameters** | `url.searchParams.get('page')` | When query string changes |
| **Fetch URLs** | `fetch('/api/posts')` | When you call `invalidate('/api/posts')` |
| **Parent Data** | `await parent()` | When parent load re-runs |

```javascript
// src/routes/blog/[slug]/+page.js
export async function load({ params, url, fetch }) {
    // Automatically depends on:
    // - params.slug (URL parameter)
    // - url.searchParams (query string)
    // - '/api/posts/...' (fetch URL)
    
    const page = url.searchParams.get('page') ?? '1';
    const post = await fetch(`/api/posts/${params.slug}?page=${page}`)
        .then(r => r.json());
    
    return { post };
}
```

> [!IMPORTANT]
> When `params.slug` or the `page` query parameter changes, this load function automatically re-runs.

---

## ðŸ”— Custom Dependencies with `depends()`

Use `depends()` to declare custom dependencies that aren't automatically tracked.

### Basic Usage

```javascript
// src/routes/dashboard/+page.js
export async function load({ fetch, depends }) {
    // Declare a custom dependency
    depends('app:dashboard');
    
    const stats = await fetch('/api/stats').then(r => r.json());
    return { stats };
}
```

```svelte
<!-- Somewhere in your app -->
<script>
    import { invalidate } from '$app/navigation';
    
    async function refreshDashboard() {
        // Re-runs all loads that depend on 'app:dashboard'
        await invalidate('app:dashboard');
    }
</script>

<button onclick={refreshDashboard}>Refresh Dashboard</button>
```

### Naming Conventions

> [!TIP]
> Use a consistent naming scheme for custom dependencies:
> - `app:resource` - For app-wide resources (e.g., `app:user`, `app:theme`)
> - `feature:action` - For feature-specific actions (e.g., `cart:update`, `posts:refresh`)

---

## ðŸ”„ URL-Based Dependencies

### Query Parameters

```javascript
// src/routes/products/+page.js
export async function load({ url, fetch }) {
    const category = url.searchParams.get('category') ?? 'all';
    const sort = url.searchParams.get('sort') ?? 'newest';
    
    const products = await fetch(
        `/api/products?category=${category}&sort=${sort}`
    ).then(r => r.json());
    
    return { products, category, sort };
}
```

When the URL changes from `/products?category=phones` to `/products?category=laptops`, the load function automatically re-runs.

---

## ðŸ“¡ Fetch-Based Dependencies

Every URL you `fetch()` becomes a dependency.

```javascript
// src/routes/blog/+page.js
export async function load({ fetch }) {
    // This load depends on '/api/posts'
    const posts = await fetch('/api/posts').then(r => r.json());
    return { posts };
}
```

```javascript
// Later, in any component
import { invalidate } from '$app/navigation';

async function refreshPosts() {
    // Re-runs all loads that fetched '/api/posts'
    await invalidate('/api/posts');
}
```

### Invalidating by URL Pattern

```javascript
// Invalidate all API calls
await invalidate(url => url.pathname.startsWith('/api/'));

// Invalidate everything
await invalidate(() => true);
```

---

## ðŸŒ³ Parent Dependencies

When you call `await parent()`, your load function depends on all parent layouts.

```javascript
// src/routes/+layout.server.js
export async function load({ cookies }) {
    const user = await getUserFromSession(cookies);
    return { user };
}
```

```javascript
// src/routes/dashboard/+page.server.js
export async function load({ parent }) {
    // Depends on parent layout
    const { user } = await parent();
    const settings = await getSettings(user.id);
    return { settings };
}
```

> [!WARNING]
> If the root layout re-runs (e.g., user logs in), all child loads that call `parent()` will also re-run.

### Avoiding Unnecessary Parent Dependencies

```javascript
// âŒ BAD: Creates dependency even though we don't use parent data
export async function load({ parent, fetch }) {
    await parent(); // Unnecessary!
    const data = await fetch('/api/data').then(r => r.json());
    return { data };
}

// âœ… GOOD: No parent dependency
export async function load({ fetch }) {
    const data = await fetch('/api/data').then(r => r.json());
    return { data };
}
```

---


---

## ðŸ“Š Summary

| Dependency Type | How It's Tracked | How to Invalidate |
| :--- | :--- | :--- |
| **URL Parameters** | Automatic (`params.id`) | Navigate to new URL |
| **Search Parameters** | Automatic (`url.searchParams`) | Navigate with new query string |
| **Fetch URLs** | Automatic (`fetch('/api/...')`) | `invalidate('/api/...')` |
| **Parent Data** | Automatic (`await parent()`) | Invalidate parent load |
| **Custom** | Manual (`depends('app:x')`) | `invalidate('app:x')` |

---

**Next Up**: [Invalidating Load Functions](./02.%20Invalidating%20Load%20Functions.md) â†’
