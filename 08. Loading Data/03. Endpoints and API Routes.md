# 03. Endpoints and API Routes

SvelteKit allows you to create API endpoints alongside your pages using `+server.js` files. These endpoints can handle any HTTP method and are perfect for building REST APIs.

---

## ðŸŽ¯ What Are Endpoints?

An **endpoint** is a `+server.js` (or `+server.ts`) file that exports functions for HTTP methods like `GET`, `POST`, `PUT`, `PATCH`, and `DELETE`.

```javascript
// src/routes/api/hello/+server.js
export function GET() {
  return new Response('Hello, World!');
}
```

Visiting `/api/hello` returns "Hello, World!".

---

## ðŸ“ Creating Basic Endpoints

### Returning JSON

```javascript
// src/routes/api/users/+server.js
import { json } from '@sveltejs/kit';

export async function GET() {
  const users = [
    { id: 1, name: 'Alice' },
    { id: 2, name: 'Bob' }
  ];
  
  return json(users);
}
```

The `json()` helper sets the correct `Content-Type` header automatically.

### With Status Codes

```javascript
import { json } from '@sveltejs/kit';

export async function GET() {
  return json(
    { message: 'Created successfully' },
    { status: 201 }
  );
}
```

### Custom Headers

```javascript
import { json } from '@sveltejs/kit';

export async function GET() {
  return json(
    { data: 'cached' },
    {
      headers: {
        'Cache-Control': 'max-age=3600',
        'X-Custom-Header': 'my-value'
      }
    }
  );
}
```

---

## ðŸ“¬ Handling POST Requests

### JSON Body

```javascript
// src/routes/api/posts/+server.js
import { json, error } from '@sveltejs/kit';
import { db } from '$lib/server/database';

export async function POST({ request }) {
  const body = await request.json();
  
  // Validate
  if (!body.title || !body.body) {
    throw error(400, 'Title and body are required');
  }
  
  // Create in database
  const post = await db.post.create({
    data: {
      title: body.title,
      body: body.body,
      userId: body.userId || 1,
      tags: body.tags || []
    }
  });
  
  return json(post, { status: 201 });
}
```

### Form Data

```javascript
// src/routes/api/upload/+server.js
import { json } from '@sveltejs/kit';

export async function POST({ request }) {
  const formData = await request.formData();
  
  const name = formData.get('name');
  const file = formData.get('file'); // File object
  
  // Process file...
  const buffer = await file.arrayBuffer();
  
  return json({ 
    message: 'Uploaded',
    filename: file.name,
    size: file.size
  });
}
```

---

## ðŸ”„ Full CRUD Example

```javascript
// src/routes/api/todos/+server.js
import { json, error } from '@sveltejs/kit';
import { db } from '$lib/server/database';

// GET /api/todos - List all
export async function GET({ url }) {
  const limit = Number(url.searchParams.get('limit')) || 10;
  const offset = Number(url.searchParams.get('offset')) || 0;
  
  const todos = await db.todo.findMany({
    take: limit,
    skip: offset,
    orderBy: { createdAt: 'desc' }
  });
  
  return json(todos);
}

// POST /api/todos - Create new
export async function POST({ request, locals }) {
  if (!locals.user) {
    throw error(401, 'Unauthorized');
  }
  
  const { todo } = await request.json();
  
  const newTodo = await db.todo.create({
    data: {
      todo,
      userId: locals.user.id,
      completed: false
    }
  });
  
  return json(newTodo, { status: 201 });
}
```

```javascript
// src/routes/api/todos/[id]/+server.js
import { json, error } from '@sveltejs/kit';
import { db } from '$lib/server/database';

// GET /api/todos/:id - Get single
export async function GET({ params }) {
  const todo = await db.todo.findUnique({
    where: { id: params.id }
  });
  
  if (!todo) {
    throw error(404, 'Todo not found');
  }
  
  return json(todo);
}

// PATCH /api/todos/:id - Update
export async function PATCH({ params, request }) {
  const updates = await request.json();
  
  const todo = await db.todo.update({
    where: { id: params.id },
    data: updates
  });
  
  return json(todo);
}

// DELETE /api/todos/:id - Delete
export async function DELETE({ params }) {
  await db.todo.delete({
    where: { id: params.id }
  });
  
  return new Response(null, { status: 204 });
}
```

---

## ðŸ”— Pages & Endpoints in the Same Route

You can have **both** a page and an endpoint at the same route. SvelteKit routes to the appropriate handler based on the `Accept` header and request method.

### File Structure

```
src/routes/posts/[slug]/
â”œâ”€â”€ +page.svelte      â† Renders HTML page
â”œâ”€â”€ +page.server.js   â† Page load function
â””â”€â”€ +server.js        â† API endpoint
```

### How It Works

| Request | Handler |
| :--- | :--- |
| `GET /posts/hello` (browser navigation) | `+page.svelte` |
| `GET /posts/hello` with `Accept: application/json` | `+server.js` |
| `POST /posts/hello` | `+server.js` |
| `DELETE /posts/hello` | `+server.js` |

### Example

```javascript
// src/routes/posts/[slug]/+server.js
import { json } from '@sveltejs/kit';
import { db } from '$lib/server/database';

// API: Get post as JSON
export async function GET({ params }) {
  const post = await db.post.findUnique({
    where: { slug: params.slug }
  });
  
  return json(post);
}

// API: Delete post
export async function DELETE({ params, locals }) {
  if (!locals.user?.isAdmin) {
    throw error(403, 'Forbidden');
  }
  
  await db.post.delete({ where: { slug: params.slug } });
  return new Response(null, { status: 204 });
}
```

```javascript
// src/routes/posts/[slug]/+page.server.js
import { db } from '$lib/server/database';
import { error } from '@sveltejs/kit';

// Page: Load post for rendering
export async function load({ params }) {
  const post = await db.post.findUnique({
    where: { slug: params.slug },
    include: { author: true, comments: true }
  });
  
  if (!post) throw error(404, 'Post not found');
  
  return { post };
}
```

---

## ðŸŒ Sending Fetch Requests in Load Functions

When calling your own API from a load function, use the provided `fetch` - it has special powers.

### Why Use SvelteKit's Fetch?

| Feature | Regular `fetch` | SvelteKit `fetch` |
| :--- | :--- | :--- |
| Runs on server during SSR | âœ… | âœ… |
| Inherits cookies | âŒ | âœ… |
| Relative URLs on server | âŒ | âœ… |
| Request deduplication | âŒ | âœ… |

### Example

```javascript
// src/routes/dashboard/+page.js
export async function load({ fetch }) {
  // Use the provided fetch, not global fetch!
  const res = await fetch('/api/user/profile');
  const profile = await res.json();
  
  return { profile };
}
```

### Fetching External APIs

```javascript
export async function load({ fetch }) {
  // External APIs work too
  const weather = await fetch('https://api.weather.com/current')
    .then(r => r.json());
  
  return { weather };
}
```

---

## ðŸª Cookies and Headers in Endpoints

### Reading Cookies

```javascript
export async function GET({ cookies }) {
  const session = cookies.get('session');
  const theme = cookies.get('theme');
  
  return json({ session: !!session, theme });
}
```

### Setting Cookies

```javascript
export async function POST({ cookies, request }) {
  const { username, password } = await request.json();
  
  const user = await authenticate(username, password);
  
  cookies.set('session', user.sessionId, {
    path: '/',
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    maxAge: 60 * 60 * 24 * 7 // 1 week
  });
  
  return json({ success: true });
}
```

### Reading Headers

```javascript
export async function GET({ request }) {
  const authHeader = request.headers.get('Authorization');
  const userAgent = request.headers.get('User-Agent');
  
  return json({ authHeader, userAgent });
}
```

### Setting Response Headers

```javascript
export async function GET({ setHeaders }) {
  setHeaders({
    'Cache-Control': 'max-age=3600',
    'X-Powered-By': 'SvelteKit'
  });
  
  return json({ cached: true });
}
```

---

## âš ï¸ Common Pitfalls

### âŒ Pitfall 1: Forgetting to Return Response

```javascript
// âŒ BAD: No return statement
export async function POST({ request }) {
  const data = await request.json();
  await saveToDatabase(data);
  // Missing return!
}

// âœ… GOOD: Always return a Response
export async function POST({ request }) {
  const data = await request.json();
  await saveToDatabase(data);
  return json({ success: true });
}
```

---

### âŒ Pitfall 2: Using Global Fetch in Load Functions

```javascript
// âŒ BAD: Global fetch doesn't have cookie context on server
export async function load() {
  const res = await fetch('/api/user'); // Wrong!
  return { user: await res.json() };
}

// âœ… GOOD: Use the provided fetch
export async function load({ fetch }) {
  const res = await fetch('/api/user'); // Correct!
  return { user: await res.json() };
}
```

---

### âŒ Pitfall 3: Not Handling Errors

```javascript
// âŒ BAD: Unhandled errors return 500 with stack trace
export async function GET() {
  const data = await riskyOperation();
  return json(data);
}

// âœ… GOOD: Handle errors explicitly
import { error } from '@sveltejs/kit';

export async function GET() {
  try {
    const data = await riskyOperation();
    return json(data);
  } catch (e) {
    console.error('Operation failed:', e);
    throw error(500, 'Internal server error');
  }
}
```

---

## âœ… Best Practices

### 1. Organize API Routes Logically

```
src/routes/api/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ login/+server.js
â”‚   â”œâ”€â”€ logout/+server.js
â”‚   â””â”€â”€ register/+server.js
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ +server.js           # GET all, POST create
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ +server.js       # GET one, PATCH, DELETE
â””â”€â”€ posts/
    â”œâ”€â”€ +server.js
    â””â”€â”€ [slug]/+server.js
```

### 2. Use Type-Safe Handlers

```typescript
// src/routes/api/users/+server.ts
import type { RequestHandler } from './$types';
import { json } from '@sveltejs/kit';

export const GET: RequestHandler = async ({ url }) => {
  const limit = Number(url.searchParams.get('limit')) || 10;
  // TypeScript knows the return type
  return json({ users: [], limit });
};
```

### 3. Validate Input Data

```javascript
import { error, json } from '@sveltejs/kit';

export async function POST({ request }) {
  const body = await request.json();
  
  // Validation
  const errors = [];
  if (!body.email) errors.push('Email is required');
  if (!body.password) errors.push('Password is required');
  if (body.password?.length < 8) errors.push('Password must be 8+ characters');
  
  if (errors.length) {
    throw error(400, { message: 'Validation failed', errors });
  }
  
  // Proceed...
}
```

### 4. Use Appropriate Status Codes

| Status | When to Use |
| :--- | :--- |
| `200 OK` | Successful GET, PATCH |
| `201 Created` | Successful POST that creates |
| `204 No Content` | Successful DELETE |
| `400 Bad Request` | Invalid input |
| `401 Unauthorized` | Not logged in |
| `403 Forbidden` | Logged in but not allowed |
| `404 Not Found` | Resource doesn't exist |
| `500 Internal Error` | Server-side error |

---

## ðŸ“Š Summary

| Concept | Key Point |
| :--- | :--- |
| **`+server.js`** | Creates API endpoints at that route |
| **`json()`** | Helper to return JSON responses |
| **HTTP methods** | Export `GET`, `POST`, `PATCH`, `DELETE` functions |
| **Request body** | Use `request.json()` or `request.formData()` |
| **Same route** | Pages and endpoints can coexist |
| **Provided `fetch`** | Use it in load functions for cookie inheritance |

---

**Next Up**: [Navigation Hooks and Loading UI](./04.%20Navigation%20Hooks%20and%20Loading%20UI.md) â†’
