# 03. The Script Module

In Svelte components, your code normally runs **once per instance**. That means if you have 10 `<Button>` components, the `<script>` runs 10 times, creating 10 independent sets of variables.

Sometimes, you need code to run **once per module** (once for the whole application) or share data between all instances of a component. This is where `<script module>` comes in.

---

## ðŸ“¦ What is `<script module>`?

A block marked with `module` executes when the component javascript file is first loaded, *before* any instances are created.

```svelte
<!-- Counter.svelte -->
<script module>
	// This runs ONCE
	let totalCount = $state(0);

    export function getGlobalCount() {
        return totalCount;
    }
</script>

<script>
	// This runs PER INSTANCE
	let localCount = $state(0);

	function increment() {
		localCount += 1;
		totalCount += 1;
	}
</script>

<button onclick={increment}>
	Local: {localCount} | Global: {totalCount}
</button>
```

### Key Differences
| Feature | `<script>` | `<script module>` |
| :--- | :--- | :--- |
| **Execution** | Once per component instance | Once per application load |
| **Scope** | Local to the instance | Shared across all instances |
| **Exports** | Component Props | Module Exports (imports) |

---

## ðŸ“¤ Exporting from Components

You can export functions or constants from a component file using the script module. This makes the component file act like a regular `.ts` or `.js` module.

```svelte
<!-- Modal.svelte -->
<script module>
	export function alertHello() {
		alert('Hello from Modal Module!');
	}
</script>

<div>I am a modal</div>
```

**Usage:**

```svelte
<!-- App.svelte -->
<script>
	import Modal, { alertHello } from './Modal.svelte';
</script>

<button onclick={alertHello}>Say Hello</button>
<Modal />
```

---

## ðŸ”„ Use Case: Controlling Multiple Instances

A classic use case is coordinating media players or accordions where **only one** should be active at a time.

### Example: The Singleton Audio Player

Imagine you have multiple `<AudioPlayer>` components on a page. You want to ensure that if user plays one, all others pause.

**AudioPlayer.svelte**
```svelte
<script module>
	// Store references to all active instances
	// In Svelte 5, we can use a simpler approach: track the "current active" player
    // This variable is shared by ALL AudioPlayer instances
	let currentPlaying = $state(null);
</script>

<script>
	let { src } = $props();
	let audio; // DOM reference
	let paused = $state(true);

	// Effect: If 'currentPlaying' changes and it's NOT me, I should pause.
	$effect(() => {
		if (currentPlaying !== audio && !paused) {
            // Technically binding handles this, but explicit logic is clear:
			paused = true;
		}
	});

	function handlePlay() {
        // When I start playing, I declare myself as the current player.
        // All other instances see this change via the module variable.
		currentPlaying = audio;
        paused = false;
	}
    
    function handlePause() {
        paused = true;
        if (currentPlaying === audio) {
            currentPlaying = null;
        }
    }
</script>

<audio
	bind:this={audio}
	{src}
	bind:paused
    onplay={handlePlay}
    onpause={handlePause}
    controls
></audio>
```

In this pattern:
1.  All players share the `currentPlaying` variable.
2.  When Player A starts `play`, it sets `currentPlaying = Player A`.
3.  Player B sees `currentPlaying` changed to Player A.
4.  Player B pauses itself.

---

## Summary

*   Use `<script module>` for code that should run **once**, regardless of how many times the component is used.
*   It allows you to **export functions** (helpers) directly from `.svelte` files.
*   It enables **data sharing** between instances, perfect for exclusionary logic (accordions, media players) or global counters.
